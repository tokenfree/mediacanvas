<!DOCTYPE html>
<html>
<head>
  <link href="favicon.ico" rel="icon" type="image/x-icon"/>
  <title>Media Canvas</title>
  <style>
    /* Import Roboto for body text, fallback to system fonts */
    @font-face {
      font-family: 'Roboto';
      src: url('Roboto/Roboto-Regular.ttf') format('truetype');
    }
    @font-face {
      font-family: 'Roboto-Bold';
      src: url('Roboto/Roboto-Bold.ttf') format('truetype');
    }

    body {
      font-family: Roboto, Arial, sans-serif;
      margin: 0;
      background: #f9f9f9;
      overflow: hidden;
      position: relative;
      user-select: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
    }

    .image-container {
      position: relative;
      width: 100%;
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      background: white;
    }

    .background-blur {
      display: none;
    }

    .thumbnail {
      width: 200px;
      height: 200px;
      object-fit: cover;
      border-radius: 50px;
      cursor: pointer;
      transition: transform 0.3s ease-in-out;
      position: relative;
      z-index: 1;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
    }

    .thumbnail:hover {
      transform: scale(1.05);
    }

    .control-buttons {
      display: flex;
      align-items: center;
      gap: 20px;
      margin-left: 20px;
    }

    .upload-button,
    .blur-toggle {
      width: 50px;
      height: 50px;
      background: #007bff;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2em;
      color: #fff;
      cursor: pointer;
      position: relative;
      z-index: 1;
      transition: background-color 0.3s ease;
    }

    .blur-toggle {
      width: 50px;
      height: 50px;
      background: transparent url('blur.png') no-repeat center;
      background-size: 50px 50px;
      border-radius: 50%;
      cursor: pointer;
      position: relative;
      z-index: 1;
      transition: all 0.3s ease;
      filter: grayscale(100%);
    }

    .blur-toggle.active {
      background: transparent url('blur.png') no-repeat center;
      background-size: 50px 50px;
      filter: none;
    }

    .full-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(255, 255, 255, 0.95);
    }

    .full-screen .background-blur {
      display: none;
      position: absolute;
      top: 50%;
      left: 50%;
      width: 120%;
      height: 120%;
      background-size: cover;
      background-position: center;
      filter: blur(25px) brightness(0.85);
      opacity: 0;
      transform: translate(-50%, -50%) scale(1.2);
      will-change: background-image, opacity;
    }

    .full-screen .background-blur.visible {
      opacity: 0.9;
      transition: opacity 0.15s ease-out;
    }

    .full-screen img,
    .full-screen video {
      max-width: 90%;
      max-height: 90%;
      border-radius: 50px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      position: relative;
      z-index: 1;
    }

    .full-screen video {
      border-radius: 20px;
    }

    .full-screen video::-webkit-media-controls-panel {
      position: absolute;
      bottom: 0;
      width: 100%;
      background: rgba(0, 0, 0, 0.5);
    }

    .full-screen .index {
      position: absolute;
      top: 20px;
      right: 20px;
      font-size: 1.5em;
      color: #000;
      background-color: #f5f5f7;
      padding: 5px 10px;
      border-radius: 10px;
      cursor: pointer;
      z-index: 2;
    }

    .arrow {
      position: absolute;
      width: 44px;
      height: 44px;
      background: rgba(255, 255, 255, 0.9);
      cursor: pointer;
      display: none;
      z-index: 2;
      border-radius: 50%;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      transition: all 0.2s ease-in-out;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }

    .arrow::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 10px;
      height: 10px;
      border: solid #000;
      border-width: 2px 2px 0 0;
      opacity: 0.8;
    }

    .left-arrow {
      left: 24px;
    }

    .left-arrow::before {
      transform: translate(-35%, -50%) rotate(-135deg);
    }

    .right-arrow {
      right: 24px;
    }

    .right-arrow::before {
      transform: translate(-65%, -50%) rotate(45deg);
    }

    .arrow:hover {
      background: rgba(255, 255, 255, 0.95);
      transform: scale(1.05);
    }

    .arrow:active {
      background: rgba(255, 255, 255, 1);
      transform: scale(0.95);
    }

    .exit-button {
      position: absolute;
      top: 20px;
      left: 20px;
      width: 50px;
      height: 50px;
      background: url('exit.png') no-repeat;
      background-size: contain;
      border: none;
      outline: none;
      display: none;
      z-index: 2;
    }

    .download-button {
      position: absolute;
      top: 20px;
      left: 80px;
      width: 50px;
      height: 50px;
      background: rgba(255, 255, 255, 0.9);
      border: none;
      border-radius: 50%;
      display: none;
      z-index: 2;
      cursor: pointer;
      transition: all 0.2s ease-in-out;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .download-button:hover {
      background: rgba(255, 255, 255, 0.95);
      transform: scale(1.05);
    }

    .download-button:active {
      transform: scale(0.95);
    }

    .download-button::before {
      content: '⬇';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 20px;
      color: #007bff;
      font-weight: bold;
    }

    .controls-toggle-button {
      position: absolute;
      top: 20px;
      left: 140px;
      width: 50px;
      height: 50px;
      background: rgba(255, 255, 255, 0.9);
      border: none;
      border-radius: 50%;
      display: none;
      z-index: 2;
      cursor: pointer;
      transition: all 0.2s ease-in-out;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .controls-toggle-button:hover {
      background: rgba(255, 255, 255, 0.95);
      transform: scale(1.05);
    }

    .controls-toggle-button:active {
      transform: scale(0.95);
    }

    .controls-toggle-button::before {
      content: '⚙';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 20px;
      color: #007bff;
      font-weight: bold;
    }

    .arrow.hidden {
      opacity: 0;
    }

    #file-input {
      display: none;
    }

    /* ------------------------------------------------------
       List styling for the “Image/Video” menu
       ------------------------------------------------------ */
    .image-list {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 0; /* we’ll let each <li> handle its own padding */
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      max-height: 80vh;
      overflow-y: auto;
      z-index: 3;
      display: none;
    }
    .image-list ul {
      list-style: none;
      margin: 0;
      padding: 0;
    }
    .image-list ul li {
      display: flex;
      align-items: center;
      padding: 8px 12px;                /* generous hit target */
      font-size: 16px;                  /* matches symbol size if used */
      color: #111;                      /* near-black for maximum contrast */
      border-bottom: 1px solid #E0E0E0; /* subtle separator line */
      cursor: pointer;
      white-space: nowrap;
      overflow: hidden;
    }
    .image-list ul li:last-child {
      border-bottom: none;
    }
    /* “Image”/“Video” label styling */
    .image-list ul li .media-label {
      font-weight: 600;                 /* semibold, HIG style */
      margin-right: 0.5em;
      color: #111;
      flex-shrink: 0;                   /* keep full width of label */
    }
    /* Numeric index (“1.”, “2.”, etc.) */
    .image-list ul li .file-index {
      margin-right: 0.3em;
      color: #111;
      flex-shrink: 0;
    }
    /* File name will truncate if too long */
    .image-list ul li .file-name {
      flex-grow: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    /* Darken/hightlight on hover */
    .image-list ul li:hover {
      background-color: #F5F5F7;
    }
    /* Optional: adjust scrollbar styling to match HIG aesthetic */
    .image-list::-webkit-scrollbar {
      width: 8px;
    }
    .image-list::-webkit-scrollbar-track {
      background: #f1f1f1;
    }
    .image-list::-webkit-scrollbar-thumb {
      background-color: #C4C4C6;
      border-radius: 4px;
    }
    .image-list::-webkit-scrollbar-thumb:hover {
      background-color: #A0A0A3;
    }

    /* Selected Image Controls Styling */
    .image-controls-panel {
      position: fixed;
      top: 20px;
      right: 20px;
      width: 300px;
      background: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
      z-index: 4;
      display: none;
      max-height: 80vh;
      overflow-y: auto;
    }

    .controls-section-title {
      font-size: 14px;
      font-weight: bold;
      color: #555;
      margin-bottom: 15px;
      text-transform: uppercase;
      letter-spacing: 1px;
      border-bottom: 2px solid #007bff;
      padding-bottom: 5px;
    }

    .controls-form-group {
      margin-bottom: 15px;
    }

    .controls-form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
      color: #333;
      font-size: 12px;
    }

    .controls-form-group input[type="number"],
    .controls-form-group input[type="range"] {
      width: 100%;
      padding: 6px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 12px;
    }

    .controls-slider-container {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .controls-slider {
      flex: 1;
      height: 4px;
      border-radius: 2px;
      background: #ddd;
      outline: none;
      -webkit-appearance: none;
    }

    .controls-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: #007bff;
      cursor: pointer;
    }

    .controls-slider::-moz-range-thumb {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: #007bff;
      cursor: pointer;
      border: none;
    }

    .controls-button-group {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
      margin-bottom: 15px;
    }

    .control-action-btn {
      padding: 8px;
      border: 1px solid #ddd;
      background: white;
      border-radius: 5px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      transition: background 0.3s;
    }

    .control-action-btn:hover {
      background: #f0f0f0;
    }

    .control-action-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .no-selection-message {
      text-align: center;
      color: #999;
      font-style: italic;
      padding: 20px;
      font-size: 14px;
    }

    .close-controls-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      width: 30px;
      height: 30px;
      background: transparent;
      border: none;
      cursor: pointer;
      font-size: 20px;
      color: #666;
      line-height: 1;
    }

    .close-controls-btn:hover {
      color: #000;
    }
  </style>
</head>
<body>
  <div class="image-container">
    <div class="background-blur"></div>
    <img class="thumbnail" src="thumbnail.png"/>
    <div class="control-buttons">
      <div class="upload-button" onclick="document.getElementById('file-input').click()">+</div>
      <div class="blur-toggle" title="Toggle Background Blur"></div>
      <button onclick="$('.image-controls-panel').toggle()" style="padding: 10px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; margin-left: 10px;">Toggle Controls</button>
    </div>
  </div>

  <input type="file" id="file-input" multiple accept="image/*,video/*">

  <div class="full-screen">
    <div class="background-blur"></div>
    <div class="background-blur"></div>
    <img src=""/>
    <video controls style="display: none;"></video>
    <div class="index"></div>
    <div class="exit-button"></div>
    <div class="download-button" title="Download with blur effect"></div>
    <div class="controls-toggle-button" title="Image Controls"></div>
    <div class="arrow left-arrow"></div>
    <div class="arrow right-arrow"></div>
  </div>

  <div class="image-list">
    <ul></ul>
  </div>

  <div class="image-controls-panel">
    <button class="close-controls-btn" title="Close">×</button>
    <div class="controls-section-title">Selected Image Controls</div>
    <div id="selectedImageInfo" class="no-selection-message">Select an image to edit its properties</div>
    
    <div id="imageControlsContent" style="display: none;">
      <div class="controls-button-group">
        <button class="control-action-btn" id="zoomIn" title="Zoom In">🔍+</button>
        <button class="control-action-btn" id="zoomOut" title="Zoom Out">🔍-</button>
        <button class="control-action-btn" id="resetZoom" title="Reset Zoom">⚡</button>
        <button class="control-action-btn" id="centerImage" title="Center">📍</button>
      </div>

      <div class="controls-form-group">
        <label>Image scale</label>
        <div class="controls-slider-container">
          <input type="range" class="controls-slider" id="scaleSlider" min="10" max="300" value="100">
          <span id="scaleValue">100</span>%
        </div>
      </div>

      <div class="controls-form-group">
        <label>Opacity</label>
        <div class="controls-slider-container">
          <input type="range" class="controls-slider" id="opacitySlider" min="0" max="100" value="100">
          <span id="opacityValue">100</span>%
        </div>
      </div>

      <div class="controls-form-group">
        <label>Rotation (degrees)</label>
        <div class="controls-slider-container">
          <input type="range" class="controls-slider" id="rotationSlider" min="-180" max="180" value="0">
          <span id="rotationValue">0</span>°
        </div>
      </div>

      <div class="controls-form-group">
        <label>Position X</label>
        <input type="number" id="posXInput" value="0" step="1">
      </div>

      <div class="controls-form-group">
        <label>Position Y</label>
        <input type="number" id="posYInput" value="0" step="1">
      </div>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script>
    // Polyfill for roundRect if not supported
    if (!CanvasRenderingContext2D.prototype.roundRect) {
      CanvasRenderingContext2D.prototype.roundRect = function (x, y, width, height, radius) {
        if (width < 2 * radius) radius = width / 2;
        if (height < 2 * radius) radius = height / 2;
        
        this.beginPath();
        this.moveTo(x + radius, y);
        this.arcTo(x + width, y, x + width, y + height, radius);
        this.arcTo(x + width, y + height, x, y + height, radius);
        this.arcTo(x, y + height, x, y, radius);
        this.arcTo(x, y, x + width, y, radius);
        this.closePath();
      };
    }

    $(document).ready(function() {
      $('.full-screen').hide();
      $('.full-screen .index').hide();

      var media = [];
      var fileNames = [];
      var fileTypes = [];
      var currentIndex = 0;
      var blurEnabled = false;
      var preloadedImages = {};  // Cache for preloaded images
      var currentBlurIndex = 0;
      
      // Image control properties
      var imageProperties = [];
      var selectedImageIndex = -1;

      function preloadAdjacentImages(index) {
        if (!blurEnabled) return;

        const prevIndex = (index - 1 + media.length) % media.length;
        const nextIndex = (index + 1) % media.length;

        [prevIndex, nextIndex].forEach(idx => {
          if (fileTypes[idx]?.startsWith('image') && !preloadedImages[idx]) {
            const img = new Image();
            img.src = media[idx];
            preloadedImages[idx] = img;
          }
        });
      }

      $('.blur-toggle').click(function() {
        blurEnabled = !blurEnabled;
        $(this).toggleClass('active');

        const $blur = $('.full-screen .background-blur');
        if (blurEnabled) {
          $blur.css('display', 'block');
          preloadAdjacentImages(currentIndex);
        } else {
          $blur.removeClass('visible');
          setTimeout(() => $blur.css('display', 'none'), 150);
        }
      });

      function updateMedia() {
        var currentMedia = media[currentIndex];
        var currentType = fileTypes[currentIndex];
        var props = imageProperties[currentIndex] || { scale: 1, opacity: 1, rotation: 0, offsetX: 0, offsetY: 0 };

        if (currentType.startsWith('image')) {
          var $img = $('.full-screen img');
          $img.show().attr('src', currentMedia);
          $('.full-screen video').hide()[0].pause();
          
          // Apply transformations
          var transform = `translate(${props.offsetX}px, ${props.offsetY}px) scale(${props.scale}) rotate(${props.rotation}deg)`;
          $img.css({
            'transform': transform,
            'opacity': props.opacity
          });

          if (blurEnabled) {
            const $blurs = $('.full-screen .background-blur');
            const nextBlurIndex = 1 - currentBlurIndex;
            $blurs.eq(nextBlurIndex).css({
              'background-image': `url(${currentMedia})`,
              'display': 'block',
              'opacity': 0.9
            });
            $blurs.eq(currentBlurIndex).css('opacity', 0);
            currentBlurIndex = nextBlurIndex;
            preloadAdjacentImages(currentIndex);
          }
        } else if (currentType.startsWith('video')) {
          $('.full-screen img').hide();
          var $video = $('.full-screen video');
          $video.show().attr('src', currentMedia)[0].play();
          
          // Apply transformations to video as well
          var transform = `translate(${props.offsetX}px, ${props.offsetY}px) scale(${props.scale}) rotate(${props.rotation}deg)`;
          $video.css({
            'transform': transform,
            'opacity': props.opacity
          });
          
          if (blurEnabled) {
            $('.full-screen .background-blur').css({
              'display': 'block',
              'opacity': 0
            });
          }
        }

        $('.full-screen .index').text((currentIndex + 1));
      }

      function updateThumbnail(mediaUrl, type) {
        if (type.startsWith('image')) {
          $('.thumbnail').attr('src', mediaUrl);
        } else if (type.startsWith('video')) {
          var video = document.createElement('video');
          video.src = mediaUrl;
          video.addEventListener('loadeddata', function() {
            video.currentTime = 1;
          });
          video.addEventListener('seeked', function() {
            var canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);
            $('.thumbnail').attr('src', canvas.toDataURL());
          });
        }
      }

      $('.thumbnail').click(function() {
        if (media.length > 0) {
          updateMedia();
          $('.full-screen').show();
          $('.arrow, .exit-button, .download-button, .controls-toggle-button, .full-screen .index').show();
          $('.image-container').hide();
        }
      });

      // Controls toggle button
      $('.controls-toggle-button').click(function(e) {
        e.stopPropagation();
        // Set the current image as selected
        selectedImageIndex = currentIndex;
        $('.image-controls-panel').toggle();
        updateImageControls();
      });

      $(document).keydown(function(e) {
        if ($('.full-screen').is(':visible')) {
          if (e.key === 'ArrowRight') {
            currentIndex = (currentIndex + 1) % media.length;
            $('.arrow.left-arrow').addClass('hidden');
            $('.arrow.right-arrow').removeClass('hidden');
          } else if (e.key === 'ArrowLeft') {
            currentIndex = (currentIndex - 1 + media.length) % media.length;
            $('.arrow.right-arrow').addClass('hidden');
            $('.arrow.left-arrow').removeClass('hidden');
          } else if (e.key === 'Escape') {
            $('.full-screen').hide();
            $('.full-screen .index').hide();
            $('.image-container').show();
            $('.full-screen video')[0].pause();
            updateThumbnail(media[currentIndex], fileTypes[currentIndex]);
            $('.arrow').removeClass('hidden');
            return;
          }
          updateMedia();
        }
      });

      $('.arrow.left-arrow').click(function(e) {
        e.stopPropagation();
        currentIndex = (currentIndex - 1 + media.length) % media.length;
        $('.arrow.right-arrow').addClass('hidden');
        $('.arrow.left-arrow').removeClass('hidden');
        updateMedia();
      });

      $('.arrow.right-arrow').click(function(e) {
        e.stopPropagation();
        currentIndex = (currentIndex + 1) % media.length;
        $('.arrow.left-arrow').addClass('hidden');
        $('.arrow.right-arrow').removeClass('hidden');
        updateMedia();
      });

      $('.arrow.left-arrow').hover(function() {
        $(this).removeClass('hidden');
      });

      $('.arrow.right-arrow').hover(function() {
        $(this).removeClass('hidden');
      });

      $('.exit-button').click(function() {
        $('.full-screen').hide();
        $('.full-screen .index').hide();
        $('.image-container').show();
        $('.full-screen video')[0].pause();
        updateThumbnail(media[currentIndex], fileTypes[currentIndex]);
        $('.arrow').removeClass('hidden');
      });

      // Download functionality for blurred images
      $('.download-button').click(function(e) {
        e.stopPropagation();
        
        if (fileTypes[currentIndex] && fileTypes[currentIndex].startsWith('image')) {
          downloadBlurredImage();
        }
      });

      function downloadBlurredImage() {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        const currentMedia = media[currentIndex];
        const fileName = fileNames[currentIndex];
        const props = imageProperties[currentIndex] || { scale: 1, opacity: 1, rotation: 0, offsetX: 0, offsetY: 0 };
        
        const img = new Image();
        img.onload = function() {
          // Base dimensions (1920x1080)
          const baseWidth = 1920;
          const baseHeight = 1080;
          
          // Determine the appropriate multiplier based on image size
          // Check both width and height separately to ensure both fit
          let multiplier = 1;
          
          // Check if image fits within each resolution tier
          if (img.width <= 1920 && img.height <= 1080) {
            multiplier = 1; // 1920x1080
          } else if (img.width <= 3840 && img.height <= 2160) {
            multiplier = 2; // 3840x2160
          } else if (img.width <= 5760 && img.height <= 3240) {
            multiplier = 3; // 5760x3240
          } else {
            multiplier = 4; // 7680x4320
          }
          
          // Set strict canvas dimensions
          const canvasWidth = baseWidth * multiplier;
          const canvasHeight = baseHeight * multiplier;
          
          canvas.width = canvasWidth;
          canvas.height = canvasHeight;
          
          if (blurEnabled) {
            // Create blurred background that covers the entire canvas
            ctx.filter = 'blur(25px) brightness(0.85)';
            ctx.globalAlpha = 0.9;
            
            // Scale the blurred background to ensure it covers the entire canvas
            const bgScaleX = canvasWidth / img.width * 1.2; // 20% larger for blur overflow
            const bgScaleY = canvasHeight / img.height * 1.2; // 20% larger for blur overflow
            const bgScale = Math.max(bgScaleX, bgScaleY); // Use the larger scale to ensure full coverage
            
            const bgWidth = img.width * bgScale;
            const bgHeight = img.height * bgScale;
            const bgX = (canvasWidth - bgWidth) / 2;
            const bgY = (canvasHeight - bgHeight) / 2;
            
            ctx.drawImage(img, bgX, bgY, bgWidth, bgHeight);
            
            // Reset filters and alpha for the main image
            ctx.filter = 'none';
            ctx.globalAlpha = 1;
          } else {
            // Fill with white background if no blur
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, canvasWidth, canvasHeight);
          }
          
          // Calculate main image dimensions (90% of canvas size as base)
          const mainImageMaxWidth = canvasWidth * 0.9;
          const mainImageMaxHeight = canvasHeight * 0.9;
          
          let mainWidth, mainHeight;
          if (img.width / img.height > mainImageMaxWidth / mainImageMaxHeight) {
            mainWidth = mainImageMaxWidth;
            mainHeight = mainImageMaxWidth / (img.width / img.height);
          } else {
            mainHeight = mainImageMaxHeight;
            mainWidth = mainImageMaxHeight * (img.width / img.height);
          }
          
          // Apply user's scale transformation
          mainWidth *= props.scale;
          mainHeight *= props.scale;
          
          // Calculate base position (centered)
          let mainX = (canvasWidth - mainWidth) / 2;
          let mainY = (canvasHeight - mainHeight) / 2;
          
          // Apply user's position offset
          mainX += props.offsetX;
          mainY += props.offsetY;
          
          // Apply transformations with rotation
          ctx.save();
          
          // Set opacity
          ctx.globalAlpha = props.opacity;
          
          // Move to the center of where the image will be drawn
          const centerX = mainX + mainWidth / 2;
          const centerY = mainY + mainHeight / 2;
          ctx.translate(centerX, centerY);
          
          // Apply rotation
          ctx.rotate((props.rotation * Math.PI) / 180);
          
          // Add rounded corners to main image
          const cornerRadius = Math.min(mainWidth, mainHeight) * 0.05; // 5% of smaller dimension
          
          ctx.beginPath();
          ctx.roundRect(-mainWidth / 2, -mainHeight / 2, mainWidth, mainHeight, cornerRadius);
          ctx.clip();
          
          ctx.drawImage(img, -mainWidth / 2, -mainHeight / 2, mainWidth, mainHeight);
          ctx.restore();
          
          // Create download link
          canvas.toBlob(function(blob) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            
            // Create filename with blur suffix
            const fileExtension = fileName.split('.').pop();
            const fileNameWithoutExt = fileName.substring(0, fileName.lastIndexOf('.'));
            const downloadFileName = blurEnabled 
              ? `${fileNameWithoutExt}_blurred.${fileExtension}`
              : `${fileNameWithoutExt}_original.${fileExtension}`;
            
            a.download = downloadFileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
          }, 'image/png', 0.95);
        };
        
        img.src = currentMedia;
      }

      /* ------------------------------------------------------
         UPDATED: List generation for “Image/Video”
         ------------------------------------------------------ */
      $('.full-screen .index').click(function() {
        var listHtml = '';
        for (var i = 0; i < media.length; i++) {
          // Use plain text “Image” or “Video” labels in title case
          var typeLabel = fileTypes[i].startsWith('video') ? 'Video' : 'Image';

          listHtml +=
            '<li data-index="' + i + '">' +
              '<span class="media-label">' + typeLabel + '</span>' +
              '<span class="file-index">' + (i + 1) + '.</span>' +
              '<span class="file-name">' + fileNames[i] + '</span>' +
            '</li>';
        }
        $('.image-list ul').html(listHtml);
        $('.image-list').show();
      });

      $('.image-list').on('click', 'li', function(e) {
        var clickedIndex = $(this).data('index');
        
        // Check if it's a right-click or ctrl+click to open controls
        if (e.ctrlKey || e.button === 2) {
          e.preventDefault();
          selectedImageIndex = clickedIndex;
          $('.image-controls-panel').show();
          updateImageControls();
        } else {
          // Normal click - just navigate to the image
          currentIndex = clickedIndex;
          updateMedia();
        }
        $('.image-list').hide();
      });

      // Add right-click context menu prevention and use it to open controls
      $('.image-list').on('contextmenu', 'li', function(e) {
        e.preventDefault();
        var clickedIndex = $(this).data('index');
        selectedImageIndex = clickedIndex;
        $('.image-controls-panel').show();
        $('.image-list').hide();
        updateImageControls();
      });

      $(document).mouseup(function(e) {
        var container = $(".image-list");
        if (!container.is(e.target) && container.has(e.target).length === 0) {
          container.hide();
        }
      });

      $('#file-input').on('change', function(event) {
        var files = event.target.files;
        for (var i = 0; i < files.length; i++) {
          var reader = new FileReader();
          reader.onload = (function(file) {
            return function(e) {
              media.push(e.target.result);
              fileNames.push(file.name);
              fileTypes.push(file.type);
              // Initialize default properties for new image
              imageProperties.push({
                scale: 1,
                opacity: 1,
                rotation: 0,
                offsetX: 0,
                offsetY: 0
              });
              if (media.length === 1) {
                updateThumbnail(e.target.result, file.type);
              }
            };
          })(files[i]);
          reader.readAsDataURL(files[i]);
        }
      });

      // Close controls panel
      $('.close-controls-btn').click(function() {
        $('.image-controls-panel').hide();
        selectedImageIndex = -1;
      });

      // Image control buttons
      $('#zoomIn').click(function() {
        if (selectedImageIndex >= 0) {
          var props = imageProperties[selectedImageIndex];
          props.scale = Math.max(0.1, Math.min(3, props.scale * 1.2));
          updateImageControls();
          updateMedia();
        }
      });

      $('#zoomOut').click(function() {
        if (selectedImageIndex >= 0) {
          var props = imageProperties[selectedImageIndex];
          props.scale = Math.max(0.1, Math.min(3, props.scale * 0.8));
          updateImageControls();
          updateMedia();
        }
      });

      $('#resetZoom').click(function() {
        if (selectedImageIndex >= 0) {
          imageProperties[selectedImageIndex].scale = 1;
          updateImageControls();
          updateMedia();
        }
      });

      $('#centerImage').click(function() {
        if (selectedImageIndex >= 0) {
          var props = imageProperties[selectedImageIndex];
          props.offsetX = 0;
          props.offsetY = 0;
          updateImageControls();
          updateMedia();
        }
      });

      // Image property sliders
      $('#scaleSlider').on('input', function() {
        var value = $(this).val();
        $('#scaleValue').text(value);
        if (selectedImageIndex >= 0) {
          imageProperties[selectedImageIndex].scale = parseFloat(value) / 100;
          updateMedia();
        }
      });

      $('#opacitySlider').on('input', function() {
        var value = $(this).val();
        $('#opacityValue').text(value);
        if (selectedImageIndex >= 0) {
          imageProperties[selectedImageIndex].opacity = parseFloat(value) / 100;
          updateMedia();
        }
      });

      $('#rotationSlider').on('input', function() {
        var value = $(this).val();
        $('#rotationValue').text(value);
        if (selectedImageIndex >= 0) {
          imageProperties[selectedImageIndex].rotation = parseFloat(value);
          updateMedia();
        }
      });

      $('#posXInput').on('input', function() {
        if (selectedImageIndex >= 0) {
          imageProperties[selectedImageIndex].offsetX = parseFloat($(this).val()) || 0;
          updateMedia();
        }
      });

      $('#posYInput').on('input', function() {
        if (selectedImageIndex >= 0) {
          imageProperties[selectedImageIndex].offsetY = parseFloat($(this).val()) || 0;
          updateMedia();
        }
      });

      function updateImageControls() {
        var controlsContent = $('#imageControlsContent');
        var selectedInfo = $('#selectedImageInfo');
        
        if (selectedImageIndex >= 0 && selectedImageIndex < imageProperties.length) {
          var props = imageProperties[selectedImageIndex];
          controlsContent.show();
          selectedInfo.hide();
          
          // Update slider values
          $('#scaleSlider').val(Math.round(props.scale * 100));
          $('#scaleValue').text(Math.round(props.scale * 100));
          $('#opacitySlider').val(Math.round(props.opacity * 100));
          $('#opacityValue').text(Math.round(props.opacity * 100));
          $('#rotationSlider').val(props.rotation);
          $('#rotationValue').text(props.rotation);
          $('#posXInput').val(Math.round(props.offsetX));
          $('#posYInput').val(Math.round(props.offsetY));
        } else {
          controlsContent.hide();
          selectedInfo.show();
        }
      }
    });
  </script>
</body>
</html>
